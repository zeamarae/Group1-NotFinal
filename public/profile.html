<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Byte&Earn - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f0e8 0%, #f5f0e8 50%, #a25f5f 50%, #a25f5f 65%, #c4a35a 65%, #c4a35a 80%, #4a6b8a 80%, #4a6b8a 100%);
            min-height: 100vh;
        }

        .header {
            background: transparent;
            padding: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px 30px;
        }

        .logo-small {
            font-size: 28px;
            font-weight: bold;
            color: #6b2c2c;
        }

        .nav {
            display: flex;
            gap: 0;
        }

        .nav-btn {
            padding: 15px 35px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-btn:first-child {
            background: #6b2c2c;
            color: #f5f0e8;
        }

        .nav-btn:nth-child(2) {
            background: #c4a35a;
            color: #2c2c2c;
        }

        .nav-btn:nth-child(3) {
            background: #c4a35a;
            color: #2c2c2c;
        }

        .nav-btn:nth-child(4) {
            background: #4a6b8a;
            color: #f5f0e8;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .logout-btn {
            background: #dc3545;
            color: #f5f0e8;
            padding: 15px 35px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: 5px;
        }

        .logout-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 30px;
        }

        .profile-card {
            background: linear-gradient(135deg, #1a2847 0%, #2d4875 100%);
            border-radius: 20px;
            padding: 40px;
            color: #f5f0e8;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .profile-content {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 40px;
            align-items: center;
        }

        .profile-image-container {
            position: relative;
            display: inline-block;
        }

        .profile-image {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 5px solid #a25f5f;
            object-fit: cover;
            transition: border-color 0.3s;
        }

        .upload-btn {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: #6b2c2c;
            color: #f5f0e8;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .upload-btn:hover {
            background: #4a1f1f;
            transform: scale(1.1);
        }

        .upload-input {
            display: none;
        }

        .profile-info h2 {
            font-size: 36px;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .profile-info .label {
            font-size: 14px;
            color: rgba(245, 240, 232, 0.7);
            margin-bottom: 3px;
        }

        .profile-info .value {
            font-size: 18px;
            margin-bottom: 15px;
        }

        .id-section {
            text-align: right;
        }

        .id-label {
            font-size: 14px;
            color: rgba(245, 240, 232, 0.7);
            margin-bottom: 5px;
        }

        .id-number {
            font-size: 32px;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .badge-container {
            position: absolute;
            right: 40px;
            top: 50%;
            transform: translateY(-50%);
        }

        .platinum-badge {
            width: 120px;
            height: 160px;
            background: linear-gradient(135deg, #8b6f47 0%, #ffd700 50%, #8b6f47 100%);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
        }

        .badge-icon {
            width: 70px;
            height: 70px;
            background: radial-gradient(circle, #ffd700 0%, #b8860b 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin-bottom: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .badge-text {
            font-size: 12px;
            font-weight: bold;
            color: #2c2c2c;
            text-align: center;
            text-transform: uppercase;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .stat-box {
            background: rgba(245, 240, 232, 0.1);
            padding: 20px;
            border-radius: 10px;
        }

        .stat-box .label {
            font-size: 13px;
            color: rgba(245, 240, 232, 0.7);
            margin-bottom: 5px;
        }

        .stat-box .value {
            font-size: 32px;
            font-weight: bold;
        }

        .edit-section {
            margin-top: 30px;
            text-align: right;
        }

        .edit-btn {
            background: #5fb85f;
            color: white;
            border: none;
            padding: 12px 40px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(95, 184, 95, 0.3);
        }

        .edit-btn:hover {
            background: #4fa34f;
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(95, 184, 95, 0.4);
        }

        .tabs-section {
            display: none;
        }

        .tab-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .rewards-info {
            background: linear-gradient(135deg, #c4a35a 0%, #8b6f47 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .rewards-info h3 {
            font-size: 24px;
            margin-bottom: 15px;
        }

        .rewards-info p {
            line-height: 1.8;
            margin-bottom: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #f5f0e8;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            cursor: pointer;
            color: #6b2c2c;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #6b2c2c;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #6b2c2c;
            border-radius: 10px;
            font-size: 14px;
            background: white;
        }

        .save-btn {
            background: #6b2c2c;
            color: #f5f0e8;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            width: 100%;
            margin-top: 20px;
        }

        .save-btn:hover {
            background: #4a1f1f;
        }

        @media (max-width: 768px) {
            .profile-content {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .badge-container {
                position: relative;
                right: auto;
                top: auto;
                transform: none;
                margin-top: 20px;
            }

            .id-section {
                text-align: center;
            }

            .nav {
                flex-wrap: wrap;
            }

            .nav-btn {
                padding: 12px 20px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo-small"><img src="/img/byte_earn.png" alt="" width="20%" height="20%"></div>
        <nav class="nav">
            <button class="nav-btn" onclick="showSection('profile')">PROFILE</button>
            <button class="nav-btn" onclick="showSection('purchase')">PURCHASE HISTORY</button>
            <button class="nav-btn" onclick="showSection('points')">POINTS CONVERSION</button>
            <button class="nav-btn" onclick="showSection('games')">GAMES</button>
            <button class="logout-btn" onclick="handleLogout()">LOGOUT</button>
        </nav>
    </header>

    <div class="container">
        <div id="profileSection" class="section">
            <div class="profile-card">
                <div class="profile-content">
                    <div class="profile-image-container">
                        <img src="/img/noprofile.jpg" alt="Profile" class="profile-image" id="profileImg">
                        <button class="upload-btn" onclick="document.getElementById('profileUpload').click()">+</button>
                        <input type="file" id="profileUpload" class="upload-input" accept="image/*">
                    </div>
                    
                    <div class="profile-info">
                        <div class="label">Full Name</div>
                        <h2 id="displayName">Loading...</h2>
                        
                        <div class="label">Program</div>
                        <div class="value" id="displayProgram" style="color: black;">Loading...</div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                            <div>
                                <div class="label">Birthdate</div>
                                <div class="value" id="displayBirthdate">Loading...</div>
                            </div>
                            <div>
                                <div class="label">Age</div>
                                <div class="value" id="displayAge">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="label">Available Points</div>
                                <div class="value" id="displayPoints">Loading...</div>
                            </div>
                            <div class="stat-box">
                                <div class="label">Date Valid</div>
                                <div class="value" id="displayValid">Loading...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="id-section">
                            <div class="id-label">ID Number</div>
                            <div class="id-number" id="displayId">Loading...</div>
                        </div>
                        
                        <div class="platinum-badge">
                            <div class="badge-icon">‚≠ê</div>
                            <div class="badge-text">Platinum<br>Member</div>
                        </div>
                    </div>
                </div>
                
                <div class="edit-section">
                    <button class="edit-btn" onclick="openEditModal()">EDIT PROFILE</button>
                </div>
            </div>
        </div>

        <div id="purchaseSection" class="section" style="display: none;">
            <div class="tab-content">
                <h2 style="color: #6b2c2c; margin-bottom: 20px;">Purchase History</h2>
                <div id="purchaseList">
                    <p>Loading...</p>
                </div>
                <div id="monthlySummary" style="margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 10px;">
                    <strong>Loading...</strong>
                </div>
            </div>
        </div>

        <div id="pointsSection" class="section" style="display: none;">
            <div class="rewards-info">
                <h3>üéÅ Rewards Program</h3>
                <p><strong>How to Earn Points:</strong></p>
                <p>‚Ä¢ Every ‚Ç±50.00 spent = 1 reward point</p>
                <p>‚Ä¢ Birthday bonus: 10 points on your birthday!</p>
                <p>‚Ä¢ Special promotions and events</p>
                <br>
                <p><strong>How to Use Points:</strong></p>
                <p>‚Ä¢ 5 points = ‚Ç±25 discount</p>
                <p>‚Ä¢ 10 points = ‚Ç±50 discount</p>
                <p>‚Ä¢ 20 points = ‚Ç±100 discount or free meal</p>
                <p>‚Ä¢ 50 points = ‚Ç±300 discount</p>
            </div>
            <div class="tab-content">
                <h2 style="color: #6b2c2c; margin-bottom: 20px;">Convert Your Points</h2>
                <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="font-size: 18px; margin-bottom: 10px;">Your Current Points: <strong style="color: #5fb85f; font-size: 32px;" id="currentPointsDisplay">Loading...</strong></p>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <button onclick="convertPoints(5, 25)" style="padding: 20px; background: linear-gradient(135deg, #5fb85f, #4fa34f); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px;">
                        <strong>5 Points</strong><br>‚Ç±25 Discount
                    </button>
                    <button onclick="convertPoints(10, 50)" style="padding: 20px; background: linear-gradient(135deg, #5fb85f, #4fa34f); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px;">
                        <strong>10 Points</strong><br>‚Ç±50 Discount
                    </button>
                    <button onclick="convertPoints(20, 100)" style="padding: 20px; background: linear-gradient(135deg, #5fb85f, #4fa34f); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px;">
                        <strong>20 Points</strong><br>‚Ç±100 Discount
                    </button>
                    <button onclick="convertPoints(50, 300)" style="padding: 20px; background: linear-gradient(135deg, #5fb85f, #4fa34f); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px;">
                        <strong>50 Points</strong><br>‚Ç±300 Discount
                    </button>
                </div>
            </div>
        </div>

        <div id="gamesSection" class="section" style="display: none;">
            <div class="tab-content">
                <h2 style="color: #6b2c2c; margin-bottom: 20px;">üéÆ Games & Fun Activities</h2>
                <p style="margin-bottom: 30px; color: #666;">Play games to earn bonus points and have fun during your break!</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; color: white; text-align: center;">
                        <h3 style="margin-bottom: 15px;">üéØ Daily Quiz</h3>
                        <p style="margin-bottom: 20px;">Answer trivia questions and earn 2 points!</p>
                        <button style="background: white; color: #667eea; border: none; padding: 12px 30px; border-radius: 25px; font-weight: bold; cursor: pointer;">Play Now</button>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 30px; border-radius: 15px; color: white; text-align: center;">
                        <h3 style="margin-bottom: 15px;">üé≤ Lucky Spin</h3>
                        <p style="margin-bottom: 20px;">Spin the wheel for a chance to win bonus points!</p>
                        <button style="background: white; color: #f5576c; border: none; padding: 12px 30px; border-radius: 25px; font-weight: bold; cursor: pointer;">Spin Now</button>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 30px; border-radius: 15px; color: white; text-align: center;">
                        <h3 style="margin-bottom: 15px;">üèÜ Leaderboard</h3>
                        <p style="margin-bottom: 20px;">Top students earn extra rewards each month!</p>
                        <button style="background: white; color: #4facfe; border: none; padding: 12px 30px; border-radius: 25px; font-weight: bold; cursor: pointer;">View Rankings</button>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 30px; border-radius: 15px; color: white; text-align: center;">
                        <h3 style="margin-bottom: 15px;">üéÅ Daily Login</h3>
                        <p style="margin-bottom: 20px;">Login daily to collect bonus points!</p>
                        <button style="background: white; color: #43e97b; border: none; padding: 12px 30px; border-radius: 25px; font-weight: bold; cursor: pointer;">Claim Reward</button>
                    </div>
                </div>
                
                <div style="margin-top: 30px; padding: 25px; background: #fff3cd; border-radius: 10px; border-left: 5px solid #ffc107;">
                    <h4 style="color: #856404; margin-bottom: 10px;">üéâ Coming Soon!</h4>
                    <p style="color: #856404;">More exciting games and challenges are on the way. Stay tuned!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeEditModal()">&times;</span>
            <h2 style="color: #6b2c2c; margin-bottom: 25px;">Edit Profile</h2>
            
            <form onsubmit="saveProfile(event)">
                <div class="form-group">
                    <label>First Name</label>
                    <input type="text" id="editFirstName" required>
                </div>
                
                <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" id="editLastName" required>
                </div>
                
                <div class="form-group">
                    <label>ID Number</label>
                    <input type="text" id="editIdNumber" readonly style="background: #f0f0f0;">
                </div>
                
                <div class="form-group">
    <label>Program</label>
    <select id="editProgram">
        <option value="BEED">Bachelor of Elementary Education</option>
        <option value="BSED-Math">Bachelor of Secondary Education - Major in Mathematics </option>
        <option value="BTLED-HE">Bachelor of Technology and Livelihood Education - Major in Home Economics</option>
        <option value="BSIT">Bachelor of Science in Information Technology</option>
        <option value="BSIE">Bachelor of Science in Industrial Engineering</option>
        <option value="BSHM">Bachelor of Science in Hospitality Management</option>
        <option value="BSFi">Bachelor of Science in Fisheries</option>
        <option value="BIT-CompTech">Bachelor of Industrial Technology - Major in Computer Technology </option>
        <option value="BIT-Automotive">Bachelor of Industrial Technology Major in Automotive</option>
        <option value="BIT-Elex">Bachelor of Industrial Technology - Major in Electronics</option>
    </select>
</div>
                
                <div class="form-group">
                    <label>Birthdate</label>
                    <input type="date" id="editBirthdate" required>
                </div>
                
                <button type="submit" class="save-btn">Save Changes</button>
            </form>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Global socket
        const socket = io({ withCredentials: true });

        const programColors = {
    'Bachelor of Elementary Education': '#87CEEB',        // Sky Blue
    'Bachelor of Secondary Education - Major in Mathematics': '#008000',   // Green
    'Bachelor of Technology and Livelihood Education - Major in Home Economics': '#800080',    // Purple
    'Bachelor of Science in Information Technology': '#FF0000',        // Red
    'Bachelor of Science in Industrial Engineering': '#FFA500',        // Orange
    'Bachelor of Science in Hospitality Management': '#FFFF00',        // Yellow
    'Bachelor of Science in Fisheries': '#00008B',        // Dark Blue
    'Bachelor of Industrial Technology - Major in Computer Technology': '#A52A2A', // Brown
    'Bachelor of Industrial Technology Major in Automotive': '#000000', // Black
    'Bachelor of Industrial Technology - Major in Electronics': '#808080'     // Gray
};

function updateProgramColor(program) {
    const displayProgram = document.getElementById('displayProgram');
    const color = programColors[program] || '#000000'; // Default black
    displayProgram.style.color = color;
}

        // Show/hide sections
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            
            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach((btn, index) => {
                if (btn.textContent.toLowerCase().includes('logout')) return;
                btn.style.background = btn.textContent.toLowerCase().includes('profile') ? '#6b2c2c' :
                                      btn.textContent.toLowerCase().includes('games') ? '#4a6b8a' : '#c4a35a';
                btn.style.color = btn.textContent.toLowerCase().includes('purchase') || 
                                 btn.textContent.toLowerCase().includes('points') ? '#2c2c2c' : '#f5f0e8';
            });
            
            if (section === 'profile') {
                document.getElementById('profileSection').style.display = 'block';
                loadUserData(); // Refresh on tab switch
                navBtns[0].style.background = '#4a1f1f';
            } else if (section === 'purchase') {
                document.getElementById('purchaseSection').style.display = 'block';
                loadPurchases();
                navBtns[1].style.background = '#a38847';
            } else if (section === 'points') {
                document.getElementById('pointsSection').style.display = 'block';
                loadUserData(); // For points display
                navBtns[2].style.background = '#a38847';
            } else if (section === 'games') {
                document.getElementById('gamesSection').style.display = 'block';
                navBtns[3].style.background = '#3a5670';
            }
        }

        // Load user data from API
        async function loadUserData() {
            try {
                const response = await fetch('/api/profile', { credentials: 'include' });
                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('displayName').textContent = `${user.lastName}, ${user.firstName}`;
                    document.getElementById('displayProgram').textContent = user.program;
                    updateProgramColor(user.program);
                    document.getElementById('displayBirthdate').textContent = new Date(user.birthdate).toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    document.getElementById('displayAge').textContent = user.age;
                    document.getElementById('displayPoints').textContent = user.points;
                    document.getElementById('displayId').textContent = user.idNumber;
                    document.getElementById('displayValid').textContent = user.validUntil;
                    document.getElementById('currentPointsDisplay').textContent = user.points;

                    // Update profile image src if available
                    const profileImg = document.getElementById('profileImg');
                    if (user.imageUrl) {
                        profileImg.src = user.imageUrl;
                    } else {
                        profileImg.src = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'150\' height=\'150\'%3E%3Crect fill=\'%234a6b8a\' width=\'150\' height=\'150\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'white\' font-size=\'60\' font-family=\'Arial\'%3EZR%3C/text%3E%3C/svg%3E';
                    }

                    // Update border color based on program
                    const profileImage = document.querySelector('.profile-image');
                    const color = programColors[user.program] || '#a25f5f';
                    profileImage.style.borderColor = color;
                } else {
                    if (response.status === 401) {
                        window.location.href = '/';
                    }
                }
            } catch (err) {
                console.error(err);
                if (err.name !== 'TypeError') { // Avoid error on no network
                    window.location.href = '/';
                }
            }
        }

        // Handle profile picture upload
        document.getElementById('profileUpload').addEventListener('change', async function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('profilePic', file);

            try {
                const response = await fetch('/api/upload-profile-pic', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('profileImg').src = data.imageUrl;
                    showToast('Profile picture updated successfully!', '#5fb85f');
                } else {
                    const error = await response.json();
                    alert(error.message || 'Upload failed');
                }
            } catch (err) {
                alert('Upload error');
            }
        });

        // Load purchases
        async function loadPurchases() {
            try {
                const response = await fetch('/api/purchases', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    const purchaseList = document.getElementById('purchaseList');
                    purchaseList.innerHTML = ''; // Clear
                    data.transactions.forEach(t => {
                        const item = document.createElement('div');
                        item.className = 'transaction-item';
                        item.innerHTML = `
                            <div>
                                <strong>${t.item}</strong><br>
                                <small style="color: #888;">${new Date(t.date).toLocaleString()}</small>
                            </div>
                            <div style="text-align: right;">
                                <strong>‚Ç±${t.amount.toFixed(2)}</strong><br>
                                <small style="color: #5fb85f;">+${t.pointsEarned} point${t.pointsEarned > 1 ? 's' : ''}</small>
                            </div>
                        `;
                        purchaseList.appendChild(item);
                    });

                    // Update monthly summary
                    const summary = document.getElementById('monthlySummary');
                    summary.innerHTML = `
                        <strong>Total Spent This Month: ‚Ç±${data.monthly.totalSpent.toFixed(2)}</strong><br>
                        <small>Points Earned: ${data.monthly.totalPoints} points</small>
                    `;
                }
            } catch (err) {
                console.error(err);
            }
        }

        // Logout function
        async function handleLogout() {
            try {
                await fetch('/api/logout', { method: 'POST', credentials: 'include' });
            } catch (err) {
                console.error(err);
            }
            window.location.href = '/';
        }

        // Modal functions
        function openEditModal() {
            document.getElementById('editModal').classList.add('active');
            // Fetch profile to pre-fill
            fetch('/api/profile', { credentials: 'include' })
                .then(r => r.json())
                .then(user => {
                    document.getElementById('editFirstName').value = user.firstName;
                    document.getElementById('editLastName').value = user.lastName;
                    document.getElementById('editIdNumber').value = user.idNumber;
                    document.getElementById('editProgram').value = user.program;
                    document.getElementById('editBirthdate').value = new Date(user.birthdate).toISOString().split('T')[0];
                })
                .catch(() => window.location.href = '/');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        async function saveProfile(event) {
            event.preventDefault();
            
            const programSelect = document.getElementById('editProgram');
            const programFull = programSelect.options[programSelect.selectedIndex].text;
            
            const formData = {
                firstName: document.getElementById('editFirstName').value,
                lastName: document.getElementById('editLastName').value,
                program: programFull,
                birthdate: document.getElementById('editBirthdate').value
            };

            try {
                const response = await fetch('/api/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });
                if (response.ok) {
                    const data = await response.json();
                    loadUserData(); // Refresh
                    closeEditModal();
                    
                    // Success message
                    showToast('‚úì Profile updated successfully!', '#5fb85f');
                } else {
                    alert('Update failed');
                }
            } catch (err) {
                alert('Update error');
            }
        }

        // Points conversion
        async function convertPoints(pointsRequired, discountAmount) {
            try {
                const response = await fetch('/api/points/convert', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ pointsRequired, discountAmount })
                });
                const data = await response.json();
                if (response.ok) {
                    loadUserData(); // Refresh points
                    showToast(`‚úì Successfully converted ${pointsRequired} points!<br><small>You received ‚Ç±${discountAmount} discount voucher: ${data.voucher}</small>`, '#5fb85f');
                } else {
                    alert(data.message);
                }
            } catch (err) {
                alert('Conversion error');
            }
        }

        // Helper to show toast
        function showToast(message, bgColor) {
            const toast = document.createElement('div');
            toast.style.cssText = `position: fixed; top: 20px; right: 20px; background: ${bgColor}; color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 2000; max-width: 300px; line-height: 1.4;`;
            toast.innerHTML = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // Socket event listeners for real-time updates
        socket.on('purchaseAdded', (data) => {
            // Update purchase list if on purchase tab
            if (document.getElementById('purchaseSection').style.display !== 'none') {
                const purchaseList = document.getElementById('purchaseList');
                const item = document.createElement('div');
                item.className = 'transaction-item';
                item.innerHTML = `
                    <div>
                        <strong>${data.transaction.item}</strong><br>
                        <small style="color: #888;">${new Date(data.transaction.date).toLocaleString()}</small>
                    </div>
                    <div style="text-align: right;">
                        <strong>‚Ç±${data.transaction.amount.toFixed(2)}</strong><br>
                        <small style="color: #5fb85f;">+${data.transaction.pointsEarned} point${data.transaction.pointsEarned > 1 ? 's' : ''}</small>
                    </div>
                `;
                purchaseList.prepend(item);
                // Refetch monthly
                loadPurchases();
            }
            // Always update points
            document.getElementById('displayPoints').textContent = data.points;
            document.getElementById('currentPointsDisplay').textContent = data.points;
            showToast(`New purchase added! +${data.transaction.pointsEarned} points`, '#5fb85f');
        });

        socket.on('pointsUpdated', (data) => {
            document.getElementById('displayPoints').textContent = data.points;
            document.getElementById('currentPointsDisplay').textContent = data.points;
            showToast(`Points updated: ${data.points} remaining`, '#5fb85f');
        });

        socket.on('profileUpdated', (data) => {
            loadUserData();
            showToast('Profile updated in real-time!', '#5fb85f');
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeEditModal();
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            // Default to profile
            showSection('profile');
        });
    </script>
</body>
</html>